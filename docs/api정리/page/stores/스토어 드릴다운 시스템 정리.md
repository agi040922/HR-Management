# 스토어 드릴다운 시스템 아키텍처 문서

## 개요
HR 관리 시스템의 스토어 관리 모듈은 드릴다운 형식의 데이터 테이블을 통해 각 스토어에 귀속된 템플릿과 직원들을 한눈에 볼 수 있는 시스템입니다. 모듈화된 구조로 설계되어 유지보수성과 확장성을 고려했습니다.

## 파일 구조 및 역할

### 1. `/app/stores/page.tsx` - 메인 페이지 컴포넌트
**역할**: 스토어 관리의 메인 UI 컴포넌트 및 상태 관리

#### 주요 상태 관리
```typescript
// 데이터 상태
const [stores, setStores] = useState<StoreWithDetails[]>([]);
const [loadingData, setLoadingData] = useState(true);
const [showFormModal, setShowFormModal] = useState(false);
const [editingStore, setEditingStore] = useState<StoreWithDetails | null>(null);
const [error, setError] = useState<string | null>(null);

// 필터 및 정렬 상태
const [sortBy, setSortBy] = useState<SortOption>('created_at');
const [filterBy, setFilterBy] = useState<FilterOption>('all');
```

#### 핵심 함수들

**데이터 로딩 함수**
- `loadStores()`: 사용자의 스토어 목록과 통계 로드
- `handleLoadTemplates(storeId)`: 특정 스토어의 템플릿 목록 로드
- `handleLoadEmployees(storeId)`: 특정 스토어의 직원 목록 로드

**CRUD 작업 함수**
- `handleFormSubmit(formData)`: 스토어 생성/수정 처리
- `handleEditStore(store)`: 스토어 편집 모달 열기
- `handleDeleteStore(storeId)`: 스토어 삭제 처리

**네비게이션 함수**
- `handleViewSchedule(storeId)`: 스케줄 관리 페이지로 이동

#### 필터링 및 정렬 옵션
```typescript
type SortOption = 'created_at' | 'store_name' | 'employees_count'
type FilterOption = 'all' | 'has_templates' | 'has_employees' | 'active_only'
```

---

### 2. `/lib/api/stores-api.ts` - API 레이어
**역할**: Supabase와의 데이터 통신을 담당하는 API 함수들

#### 핵심 API 함수들

**데이터 조회**
```typescript
export async function getStoresWithDetails(userId: string): Promise<StoreWithDetails[]>
// 사용자의 모든 스토어와 관련 통계(템플릿 수, 직원 수) 조회

export async function getStoreTemplates(storeId: number): Promise<StoreTemplate[]>
// 특정 스토어의 스케줄 템플릿 목록 조회

export async function getStoreEmployees(storeId: number): Promise<StoreEmployee[]>
// 특정 스토어의 직원 목록 조회
```

**데이터 조작**
```typescript
export async function updateStoreSettings(storeId: number, updates: Partial<StoreSettings>): Promise<void>
// 스토어 기본 정보 업데이트

export async function deleteStore(storeId: number): Promise<void>
// 스토어 삭제 (관련 데이터 모두 삭제)
```

#### 타입 정의
```typescript
export interface StoreWithDetails {
  id: number;
  owner_id: string;
  store_name: string;
  open_time: string;
  close_time: string;
  time_slot_minutes: number;
  created_at: string;
  updated_at: string;
  templates_count: number;
  employees_count: number;
  active_employees_count: number;
}

export interface StoreTemplate {
  id: number;
  store_id: number;
  template_name: string;
  is_active: boolean;
  created_at: string;
  updated_at: string;
  schedule_data: any;
}

export interface StoreEmployee {
  id: number;
  store_id: number;
  name: string;
  position?: string;
  hourly_wage?: number;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}
```

---

### 3. `/components/stores/StoreDataTable.tsx` - 드릴다운 테이블 컴포넌트
**역할**: 스토어별 템플릿과 직원을 드릴다운 형식으로 표시하는 테이블 UI

#### 주요 기능

**드릴다운 확장/축소**
```typescript
const [expandedStores, setExpandedStores] = useState<Set<number>>(new Set());
const [storeData, setStoreData] = useState<Map<number, ExpandedData>>(new Map());

const toggleStoreExpansion = async (storeId: number) => {
  // 확장/축소 토글 및 데이터 로드 처리
}
```

**데이터 지연 로딩**
- 스토어 확장 시에만 템플릿과 직원 데이터 로드
- 로딩 상태 표시 및 에러 처리
- 캐싱을 통한 중복 요청 방지

**시각적 구분**
- **스토어 헤더**: 회색 배경 (`bg-gray-50`)
- **템플릿 섹션**: 파란색 아이콘 (`text-blue-600`)
- **직원 섹션**: 초록색 아이콘 (`text-green-600`)
- **활성/비활성 상태**: Badge 컴포넌트로 구분

**상호작용**
- 확장/축소 버튼 (ChevronDown/ChevronRight)
- 스케줄 보기, 편집, 삭제 버튼
- 스크롤 가능한 템플릿/직원 목록 (최대 높이 제한)

#### Props 인터페이스
```typescript
interface StoreDataTableProps {
  stores: StoreWithDetails[];
  onEditStore: (store: StoreWithDetails) => void;
  onDeleteStore: (storeId: number) => void;
  onViewSchedule: (storeId: number) => void;
  onLoadTemplates: (storeId: number) => Promise<StoreTemplate[]>;
  onLoadEmployees: (storeId: number) => Promise<StoreEmployee[]>;
}
```

---

### 4. `/components/stores/StoreFormModal.tsx` - 스토어 폼 모달
**역할**: 스토어 생성/수정을 위한 모달 UI

#### 주요 기능

**폼 필드**
- 스토어 이름 (필수)
- 오픈/마감 시간
- 시간 단위 (15분/30분/60분)

**상태 관리**
```typescript
const [formData, setFormData] = useState<StoreFormData>({
  store_name: '',
  open_time: '09:00',
  close_time: '18:00',
  time_slot_minutes: 30
});
const [loading, setLoading] = useState(false);
```

**유효성 검사**
- 스토어 이름 필수 입력 확인
- 시간 형식 검증
- 로딩 상태 중 중복 제출 방지

#### 폼 데이터 인터페이스
```typescript
export interface StoreFormData {
  store_name: string;
  open_time: string;
  close_time: string;
  time_slot_minutes: number;
}
```

---

## 데이터 흐름

### 1. 초기 로딩 과정
```
사용자 로그인 → 스토어 목록 로드 → 통계 정보 포함 표시 → 필터/정렬 적용
```

### 2. 드릴다운 확장 과정
```
스토어 확장 버튼 클릭 → 템플릿/직원 데이터 병렬 로드 → 로딩 상태 표시 → 데이터 캐싱 → UI 업데이트
```

### 3. 스토어 편집 과정
```
편집 버튼 클릭 → 폼 모달 열기 → 기존 데이터 로드 → 수정 → API 호출 → 목록 새로고침
```

### 4. 스케줄 보기 과정
```
스케줄 보기 버튼 클릭 → 스케줄 관리 페이지로 라우팅 (store 파라미터 포함)
```

---

## 주요 개선사항

### 1. 모듈화된 구조
- API 레이어 분리 (`stores-api.ts`)
- 컴포넌트 분리 (`StoreDataTable`, `StoreFormModal`)
- 타입 정의 중앙화

### 2. 성능 최적화
- 지연 로딩 (Lazy Loading)
- 데이터 캐싱
- 병렬 API 호출

### 3. 사용자 경험 개선
- 드릴다운 인터페이스
- 실시간 필터링/정렬
- 로딩 상태 표시
- 에러 처리

### 4. 확장성
- 타입 안전성 보장
- 재사용 가능한 컴포넌트
- 명확한 책임 분리

---

## 데이터베이스 연동

### 주요 테이블
- `store_settings`: 스토어 기본 정보
- `weekly_schedule_templates`: 스케줄 템플릿
- `employees`: 직원 정보

### 통계 쿼리
```sql
-- 스토어별 템플릿 수 조회
SELECT store_id, COUNT(*) as templates_count 
FROM weekly_schedule_templates 
GROUP BY store_id;

-- 스토어별 활성 직원 수 조회
SELECT store_id, COUNT(*) as active_employees_count 
FROM employees 
WHERE is_active = true 
GROUP BY store_id;
```

---

## 확장 가능성

### 1. 추가 가능한 기능
- 스토어별 매출 통계
- 직원 근무 시간 요약
- 템플릿 사용률 분석
- 스토어 간 데이터 비교

### 2. 성능 최적화
- 가상화된 테이블 (대량 데이터 처리)
- 무한 스크롤
- 검색 기능 추가

### 3. 사용자 경험 개선
- 드래그 앤 드롭 정렬
- 벌크 작업 (일괄 편집/삭제)
- 내보내기 기능
- 모바일 반응형 최적화

---

## 개발 가이드라인

### 1. 새로운 기능 추가 시
1. `stores-api.ts`에 API 함수 추가
2. 타입 정의 업데이트
3. 컴포넌트에 UI 구현
4. 메인 페이지에 상태 및 핸들러 추가

### 2. 데이터 구조 변경 시
1. 타입 정의 업데이트 (`stores-api.ts`)
2. API 함수 수정
3. 컴포넌트 렌더링 로직 수정
4. 데이터베이스 마이그레이션

### 3. 테스트 권장사항
- API 함수 단위 테스트
- 컴포넌트 렌더링 테스트
- 드릴다운 상호작용 테스트
- 필터/정렬 기능 테스트

### 4. 디버깅 팁
- 네트워크 탭에서 API 호출 확인
- React DevTools로 상태 변화 추적
- 콘솔에서 에러 로그 확인
- 타입 오류는 즉시 해결

---

## 사용법

### 기본 사용법
1. **스토어 목록 보기**: 페이지 로드 시 자동으로 스토어 목록 표시
2. **드릴다운**: 스토어 행의 화살표 버튼 클릭하여 템플릿/직원 정보 확장
3. **필터링**: 헤더의 드롭다운으로 조건별 필터링
4. **정렬**: 생성순, 이름순, 직원수순으로 정렬 가능

### 스토어 관리
1. **생성**: "새 스토어" 버튼 클릭 → 폼 작성 → 저장
2. **편집**: 스토어 행의 편집 버튼 클릭 → 폼 수정 → 저장
3. **삭제**: 스토어 행의 삭제 버튼 클릭 → 확인 → 삭제
4. **스케줄 보기**: 달력 아이콘 클릭하여 스케줄 관리 페이지로 이동

### 필터 옵션
- **전체**: 모든 스토어 표시
- **템플릿 있음**: 스케줄 템플릿이 있는 스토어만
- **직원 있음**: 등록된 직원이 있는 스토어만
- **활성 직원만**: 활성 상태 직원이 있는 스토어만

---

## 트러블슈팅

### 일반적인 문제들

1. **데이터 로딩 실패**
   - 네트워크 연결 확인
   - Supabase 연결 상태 확인
   - 사용자 권한 확인

2. **드릴다운 데이터 표시 안됨**
   - API 응답 데이터 구조 확인
   - 콘솔 에러 로그 확인
   - 스토어 ID 유효성 확인

3. **폼 제출 실패**
   - 필수 필드 입력 확인
   - 데이터 형식 검증
   - 서버 응답 상태 확인

4. **성능 이슈**
   - 대량 데이터 시 페이지네이션 고려
   - 불필요한 API 호출 최소화
   - 메모이제이션 적용 검토
