# ì¸ì¦ ë¡œì§ í˜¸í™˜ì„± ë¶„ì„ ë° í•´ê²°ë°©ì•ˆ

## ğŸ“‹ í˜„ì¬ ìƒí™© ìš”ì•½

HR ê´€ë¦¬ ì‹œìŠ¤í…œì—ì„œ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì¸ì¦(`useAuth.ts`)ê³¼ ì„œë²„ ì‚¬ì´ë“œ ë¯¸ë“¤ì›¨ì–´(`middleware.ts`) ê°„ì˜ í˜¸í™˜ì„± ë¬¸ì œê°€ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.

## ğŸ” ì£¼ìš” ë¬¸ì œì  ë¶„ì„

### 1. **ì¸ì¦ ìƒíƒœ ë™ê¸°í™” ë¬¸ì œ**

#### í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ (`useAuth.ts`)
```typescript
// React Hookìœ¼ë¡œ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì‹¤í–‰
const { data: { session }, error } = await supabase.auth.getSession()
```

#### ì„œë²„ ì‚¬ì´ë“œ (`middleware.ts`)
```typescript
// Next.js ë¯¸ë“¤ì›¨ì–´ë¡œ ì„œë²„ì—ì„œ ì‹¤í–‰
const supabase = createMiddlewareClient({ req: request, res })
const { data: { session }, error } = await supabase.auth.getSession()
```

**ë¬¸ì œì **: í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°€ ì„œë¡œ ë‹¤ë¥¸ Supabase í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ ìƒíƒœê°€ ë™ê¸°í™”ë˜ì§€ ì•ŠìŒ

### 2. **ì¿ í‚¤ ê´€ë¦¬ ë¶ˆì¼ì¹˜**

#### í˜„ì¬ ë¯¸ë“¤ì›¨ì–´ì˜ ì¿ í‚¤ ì²˜ë¦¬
```typescript
// ì—¬ëŸ¬ ì¿ í‚¤ ì´ë¦„ì„ ì‹œë„í•˜ëŠ” ë³µì¡í•œ ë¡œì§
const possibleCookieNames = [
  `sb-${process.env.NEXT_PUBLIC_SUPABASE_URL?.split('//')[1]?.split('.')[0]}-auth-token`,
  'sb-access-token', 
  'sb-refresh-token',
  'supabase-auth-token'
]
```

**ë¬¸ì œì **: 
- Supabaseì˜ í‘œì¤€ ì¿ í‚¤ ë„¤ì´ë° ê·œì¹™ê³¼ ë¶ˆì¼ì¹˜
- ì‹¤ì œ ì¿ í‚¤ ì´ë¦„: `sb-[project-ref]-auth-token`
- ë³µì¡í•œ fallback ë¡œì§ìœ¼ë¡œ ì¸í•œ ì„±ëŠ¥ ì €í•˜

### 3. **ì„ì‹œ í•´ê²°ì±…ìœ¼ë¡œ ì¸í•œ ë³´ì•ˆ ì·¨ì•½ì **

```typescript
// ğŸš¨ í˜„ì¬ ë¯¸ë“¤ì›¨ì–´ê°€ ì™„ì „íˆ ë¹„í™œì„±í™”ë¨
const DISABLE_MIDDLEWARE_AUTH = true
```

**ë¬¸ì œì **: 
- ëª¨ë“  ë¼ìš°íŠ¸ ë³´í˜¸ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”
- ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìë„ ë³´í˜¸ëœ í˜ì´ì§€ ì ‘ê·¼ ê°€ëŠ¥
- ë³´ì•ˆìƒ ë§¤ìš° ìœ„í—˜í•œ ìƒíƒœ

### 4. **Supabase Auth Helpers ë²„ì „ í˜¸í™˜ì„±**

#### í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ íŒ¨í‚¤ì§€
```typescript
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs'
```

**ë¬¸ì œì **: 
- `@supabase/auth-helpers-nextjs`ëŠ” deprecated ìƒíƒœ
- ìµœì‹  Supabase SSR íŒ¨í‚¤ì§€ì™€ í˜¸í™˜ì„± ë¬¸ì œ
- ì¿ í‚¤ ì„¤ì • ë° ì„¸ì…˜ ê´€ë¦¬ ë°©ì‹ì˜ ì°¨ì´

## ğŸ› ï¸ í•´ê²°ë°©ì•ˆ

### 1. **Supabase SSR íŒ¨í‚¤ì§€ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜**

#### íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
```bash
npm uninstall @supabase/auth-helpers-nextjs
npm install @supabase/ssr
```

#### ìƒˆë¡œìš´ ë¯¸ë“¤ì›¨ì–´ êµ¬ì¡°
```typescript
import { createServerClient } from '@supabase/ssr'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value
        },
        set(name: string, value: string, options: CookieOptions) {
          request.cookies.set({
            name,
            value,
            ...options,
          })
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          })
          response.cookies.set({
            name,
            value,
            ...options,
          })
        },
        remove(name: string, options: CookieOptions) {
          request.cookies.set({
            name,
            value: '',
            ...options,
          })
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          })
          response.cookies.set({
            name,
            value: '',
            ...options,
          })
        },
      },
    }
  )

  const { data: { user } } = await supabase.auth.getUser()
  
  // ì¸ì¦ ë¡œì§ ì²˜ë¦¬...
  
  return response
}
```

### 2. **í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ Supabase í´ë¼ì´ì–¸íŠ¸ ì—…ë°ì´íŠ¸**

#### ìƒˆë¡œìš´ `lib/supabase.ts` êµ¬ì¡°
```typescript
import { createBrowserClient } from '@supabase/ssr'

export const supabase = createBrowserClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)
```

### 3. **í†µí•©ëœ ì¸ì¦ ìƒíƒœ ê´€ë¦¬**

#### Context Provider ë„ì…
```typescript
// contexts/AuthContext.tsx
'use client'

import { createContext, useContext, useEffect, useState } from 'react'
import { User, Session } from '@supabase/supabase-js'
import { supabase } from '@/lib/supabase'

interface AuthContextType {
  user: User | null
  session: Session | null
  loading: boolean
  signOut: () => Promise<void>
}

const AuthContext = createContext<AuthContextType | undefined>(undefined)

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null)
  const [session, setSession] = useState<Session | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    // ì´ˆê¸° ì„¸ì…˜ í™•ì¸
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session)
      setUser(session?.user ?? null)
      setLoading(false)
    })

    // ì¸ì¦ ìƒíƒœ ë³€í™” ê°ì§€
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        setSession(session)
        setUser(session?.user ?? null)
        setLoading(false)
      }
    )

    return () => subscription.unsubscribe()
  }, [])

  const signOut = async () => {
    await supabase.auth.signOut()
  }

  return (
    <AuthContext.Provider value={{ user, session, loading, signOut }}>
      {children}
    </AuthContext.Provider>
  )
}

export const useAuth = () => {
  const context = useContext(AuthContext)
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider')
  }
  return context
}
```

### 4. **ë¼ìš°íŠ¸ ë³´í˜¸ ë¡œì§ ê°œì„ **

#### ê°„ì†Œí™”ëœ ë¯¸ë“¤ì›¨ì–´
```typescript
export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl
  
  // ì •ì  íŒŒì¼ ë° API ë¼ìš°íŠ¸ ì œì™¸
  if (pathname.startsWith('/_next') || 
      pathname.startsWith('/api') || 
      pathname.includes('.')) {
    return NextResponse.next()
  }

  const response = NextResponse.next()
  const supabase = createServerClient(/* ... */)
  
  const { data: { user } } = await supabase.auth.getUser()
  const isAuthenticated = !!user

  // ë³´í˜¸ëœ ë¼ìš°íŠ¸ ì²´í¬
  const protectedRoutes = ['/employees', '/payroll', '/profiles', '/schedule', '/stores', '/help', '/test']
  const isProtectedRoute = protectedRoutes.some(route => pathname.startsWith(route))

  if (isProtectedRoute && !isAuthenticated) {
    const redirectUrl = new URL('/login', request.url)
    redirectUrl.searchParams.set('from', pathname)
    return NextResponse.redirect(redirectUrl)
  }

  if (pathname === '/login' && isAuthenticated) {
    return NextResponse.redirect(new URL('/profiles', request.url))
  }

  if (pathname === '/' && isAuthenticated) {
    return NextResponse.redirect(new URL('/profiles', request.url))
  }

  if (pathname === '/' && !isAuthenticated) {
    return NextResponse.redirect(new URL('/landing', request.url))
  }

  return response
}
```

## ğŸ“‹ êµ¬í˜„ ë‹¨ê³„ë³„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
- [ ] `@supabase/auth-helpers-nextjs` ì œê±°
- [ ] `@supabase/ssr` ì„¤ì¹˜
- [ ] í™˜ê²½ë³€ìˆ˜ í™•ì¸ ë° ì„¤ì •

### Phase 2: ì„œë²„ ì‚¬ì´ë“œ ë¦¬íŒ©í† ë§
- [ ] ìƒˆë¡œìš´ `middleware.ts` êµ¬í˜„
- [ ] ì¿ í‚¤ ì²˜ë¦¬ ë¡œì§ ê°œì„ 
- [ ] ë¼ìš°íŠ¸ ë³´í˜¸ ë¡œì§ ê°„ì†Œí™”

### Phase 3: í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë¦¬íŒ©í† ë§
- [ ] `lib/supabase.ts` ì—…ë°ì´íŠ¸
- [ ] `AuthContext` êµ¬í˜„
- [ ] ê¸°ì¡´ `useAuth.ts` ë§ˆì´ê·¸ë ˆì´ì…˜

### Phase 4: í…ŒìŠ¤íŠ¸ ë° ê²€ì¦
- [ ] ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
- [ ] ë³´í˜¸ëœ ë¼ìš°íŠ¸ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
- [ ] ì„¸ì…˜ ì§€ì†ì„± í…ŒìŠ¤íŠ¸
- [ ] ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ ì‹œ ìƒíƒœ ìœ ì§€ í…ŒìŠ¤íŠ¸

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜**: í•œ ë²ˆì— ëª¨ë“  ê²ƒì„ ë³€ê²½í•˜ì§€ ë§ê³  ë‹¨ê³„ë³„ë¡œ ì§„í–‰
2. **ë°±ì—…**: ê¸°ì¡´ ì½”ë“œë¥¼ ë°±ì—…í•œ í›„ ì‘ì—… ì‹œì‘
3. **í…ŒìŠ¤íŠ¸**: ê° ë‹¨ê³„ë§ˆë‹¤ ì² ì €í•œ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
4. **í™˜ê²½ë³€ìˆ˜**: Supabase í”„ë¡œì íŠ¸ ì„¤ì • í™•ì¸ í•„ìˆ˜

## ğŸ¯ ì˜ˆìƒ íš¨ê³¼

- âœ… í´ë¼ì´ì–¸íŠ¸-ì„œë²„ ê°„ ì¸ì¦ ìƒíƒœ ë™ê¸°í™”
- âœ… í‘œì¤€ Supabase SSR íŒ¨í„´ ì ìš©
- âœ… ë³´ì•ˆ ê°•í™” (ë¼ìš°íŠ¸ ë³´í˜¸ ê¸°ëŠ¥ ë³µì›)
- âœ… ì„±ëŠ¥ ê°œì„  (ë¶ˆí•„ìš”í•œ ì¿ í‚¤ ì²´í¬ ë¡œì§ ì œê±°)
- âœ… ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ (ìµœì‹  íŒ¨í‚¤ì§€ ì‚¬ìš©)

## ğŸ“š ì°¸ê³  ìë£Œ

- [Supabase SSR ê³µì‹ ë¬¸ì„œ](https://supabase.com/docs/guides/auth/server-side/nextjs)
- [Next.js ë¯¸ë“¤ì›¨ì–´ ê°€ì´ë“œ](https://nextjs.org/docs/app/building-your-application/routing/middleware)
- [Supabase Auth Helpers ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ](https://supabase.com/docs/guides/auth/server-side/migrating-to-ssr-from-auth-helpers)
