# 근로계약서 시스템 로직 설명

## 개요
이 문서는 근로계약서 실시간 미리보기 및 PDF 생성 시스템의 구체적인 동작 로직을 설명합니다.

## 시스템 아키텍처

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   사용자 입력   │───▶│  실시간 검증    │───▶│   미리보기      │
│   (Form Input)  │    │  (Validation)   │    │   (Preview)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   데이터 저장   │    │   오류 표시     │    │   PDF 생성      │
│   (DB/JSON)     │    │  (Error UI)     │    │  (html2pdf.js)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 핵심 컴포넌트

### 1. 메인 페이지 (`/app/test/labor-contract/page.tsx`)

**역할**: 전체 시스템의 진입점 및 상태 관리

**주요 로직**:
```typescript
// 1. 계약서 유형 선택 시 기본 데이터 재설정
useEffect(() => {
  const newContract = createDefaultContract(selectedType);
  setContract(newContract);
  setValidationErrors([]);
}, [selectedType]);

// 2. 실시간 검증 (입력값 변경 시마다 실행)
useEffect(() => {
  const errors = validateLaborContract(contract);
  setValidationErrors(errors);
}, [contract]);
```

**데이터 흐름**:
1. 사용자가 계약서 유형 선택
2. `createDefaultContract()` 함수로 기본 데이터 생성
3. 입력 폼에서 데이터 변경 시 `handleContractChange()` 호출
4. 상태 업데이트 → 실시간 검증 → 미리보기 업데이트

### 2. 입력 폼 컴포넌트 (`/components/labor-contract/ContractForm.tsx`)

**역할**: 사용자 입력 인터페이스 및 데이터 수집

**주요 기능**:
- **동적 필드 표시**: 계약서 유형에 따라 필요한 입력 필드만 표시
- **실시간 검증**: 입력과 동시에 오류 메시지 표시
- **데이터 변환**: 사용자 입력을 시스템 데이터 구조로 변환

**핵심 로직**:
```typescript
// 사업주 정보 업데이트
const updateEmployer = (field: string, value: string) => {
  onChange({
    employer: { ...contract.employer, [field]: value }
  });
};

// 동적 수당 관리
const addAllowance = () => {
  const newAllowances = [...contract.salary.otherAllowances, { name: '', amount: 0 }];
  updateSalary('otherAllowances', newAllowances);
};
```

### 3. 미리보기 컴포넌트 (`/components/labor-contract/ContractPreview.tsx`)

**역할**: 실시간 계약서 미리보기 렌더링

**주요 기능**:
- **실시간 반영**: 입력 데이터 변경 시 즉시 미리보기 업데이트
- **서식 준수**: 표준 근로계약서 양식에 맞춘 레이아웃
- **조건부 렌더링**: 계약서 유형에 따른 섹션 표시/숨김

**렌더링 로직**:
```typescript
// 날짜 형식 변환
const formatDate = (dateString: string) => {
  if (!dateString) return '____년 __월 __일';
  const date = new Date(dateString);
  return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
};

// 조건부 섹션 렌더링
{contract.contractType === 'minor' && contract.minorWorkerInfo && (
  <div>연소근로자 추가 정보</div>
)}
```

## 데이터 검증 시스템

### 검증 로직 (`/lib/labor-contract-utils.ts`)

**실시간 검증 프로세스**:
1. **필수 필드 검증**: 빈 값 체크
2. **형식 검증**: 날짜, 시간, 전화번호 등 형식 확인
3. **비즈니스 로직 검증**: 최저시급, 법정근로시간 등 법적 기준 확인
4. **관계 검증**: 시작일 < 종료일, 연소근로자 나이 등

**검증 규칙 예시**:
```typescript
// 최저시급 검증
if (contract.salary.salaryType === 'hourly' && contract.salary.basicSalary < MINIMUM_WAGE) {
  errors.push({ 
    field: 'salary.basicSalary', 
    message: `시간급은 최저시급 ${MINIMUM_WAGE.toLocaleString()}원 이상이어야 합니다.` 
  });
}

// 연소근로자 나이 검증
if (contract.contractType === 'minor') {
  const age = calculateAge(contract.employee.birthdate);
  if (age >= 18) {
    errors.push({ 
      field: 'employee.birthdate', 
      message: '연소근로자는 만 18세 미만이어야 합니다.' 
    });
  }
}
```

## PDF 생성 시스템

### PDF 생성 프로세스 (`/lib/pdf-generator.ts`)

**단계별 처리**:
1. **HTML 생성**: 계약서 데이터를 HTML 템플릿으로 변환
2. **스타일 적용**: CSS를 통한 인쇄용 레이아웃 설정
3. **PDF 변환**: html2pdf.js 라이브러리로 PDF 생성
4. **다운로드**: 브라우저에서 파일 다운로드

**HTML 템플릿 생성 로직**:
```typescript
function generateContractHTML(contract: LaborContract): string {
  return `
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .container { max-width: 210mm; margin: 0 auto; }
        .section { margin-bottom: 20px; }
        // ... 상세 스타일링
      </style>
    </head>
    <body>
      <div class="container">
        <div class="title">${getContractTitle(contract.contractType)}</div>
        // ... 계약서 내용 렌더링
      </div>
    </body>
    </html>
  `;
}
```

**PDF 옵션 설정**:
```typescript
const options = {
  margin: [15, 15, 15, 15],
  filename: `근로계약서_${contract.employee.name}_${new Date().toISOString().split('T')[0]}.pdf`,
  image: { type: 'jpeg', quality: 0.98 },
  html2canvas: { scale: 2, useCORS: true, letterRendering: true },
  jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
};
```

## 타입 시스템

### 데이터 구조 (`/types/labor-contract.ts`)

**계층적 타입 정의**:
```typescript
// 메인 계약서 인터페이스
interface LaborContract {
  contractType: ContractType;
  employer: EmployerInfo;
  employee: EmployeeInfo;
  workingHours: WorkingHours;
  salary: SalaryInfo;
  socialInsurance: SocialInsurance;
  // 유형별 추가 정보 (옵셔널)
  minorWorkerInfo?: MinorWorkerInfo;
  foreignWorkerInfo?: ForeignWorkerInfo;
}
```

**타입 안전성 보장**:
- 컴파일 타임 타입 체크
- 런타임 검증과 연계
- IDE 자동완성 지원

## 상태 관리 패턴

### React 상태 관리
```typescript
// 메인 상태
const [contract, setContract] = useState<LaborContract>(createDefaultContract('permanent'));
const [validationErrors, setValidationErrors] = useState<ValidationError[]>([]);

// 상태 업데이트 패턴
const handleContractChange = (updatedContract: Partial<LaborContract>) => {
  setContract(prev => ({ ...prev, ...updatedContract }));
};
```

### 불변성 유지
- Spread 연산자를 통한 객체 복사
- 중첩 객체 업데이트 시 깊은 복사
- 상태 변경 추적 가능

## 사용자 경험 (UX) 설계

### 실시간 피드백
1. **입력 즉시 검증**: 필드에서 포커스 아웃 시 검증
2. **시각적 피드백**: 오류 필드 빨간 테두리 표시
3. **진행 상황 표시**: 완료된 섹션 체크마크 표시

### 반응형 디자인
- **데스크톱**: 좌우 분할 (입력폼 | 미리보기)
- **모바일**: 탭 전환 (입력 모드 ↔ 미리보기 모드)

### 접근성 고려사항
- 키보드 네비게이션 지원
- 스크린 리더 호환성
- 고대비 색상 사용

## 성능 최적화

### 렌더링 최적화
```typescript
// 메모이제이션을 통한 불필요한 재렌더링 방지
const memoizedPreview = useMemo(() => 
  <ContractPreview contract={contract} />, 
  [contract]
);

// 디바운싱을 통한 검증 최적화
const debouncedValidation = useCallback(
  debounce((contract) => {
    const errors = validateLaborContract(contract);
    setValidationErrors(errors);
  }, 300),
  []
);
```

### 번들 최적화
- 동적 import를 통한 PDF 라이브러리 지연 로딩
- 코드 스플리팅으로 초기 로딩 시간 단축

## 오류 처리

### 클라이언트 사이드 오류
```typescript
try {
  await generateContractPDF(contract);
} catch (error) {
  console.error('PDF 생성 오류:', error);
  // 사용자에게 친화적인 오류 메시지 표시
  alert('PDF 생성 중 오류가 발생했습니다. 다시 시도해주세요.');
}
```

### 검증 오류 표시
- 필드별 인라인 오류 메시지
- 전체 오류 요약 패널
- 오류 필드로 자동 스크롤

## 확장 가능성

### 새로운 계약서 유형 추가
1. `ContractType` enum에 새 타입 추가
2. `CONTRACT_TEMPLATES` 배열에 템플릿 정의
3. 필요시 추가 인터페이스 정의
4. 검증 로직 및 미리보기 로직 확장

### 다국어 지원
- i18n 라이브러리 통합 준비
- 텍스트 하드코딩 최소화
- 날짜/숫자 형식 로케일 대응

### API 연동 준비
```typescript
// 향후 백엔드 연동을 위한 인터페이스
interface ContractAPI {
  save(contract: LaborContract): Promise<string>;
  load(id: string): Promise<LaborContract>;
  generatePDF(id: string): Promise<Blob>;
}
```

## 보안 고려사항

### 클라이언트 사이드 보안
- XSS 방지를 위한 입력값 이스케이핑
- PDF 생성 시 악성 스크립트 차단
- 민감 정보 로컬 스토리지 저장 금지

### 데이터 검증
- 클라이언트 검증 + 서버 검증 이중화
- 입력값 길이 제한
- 특수문자 필터링

## 테스트 전략

### 단위 테스트
```typescript
// 검증 함수 테스트
describe('validateLaborContract', () => {
  it('should return error for empty company name', () => {
    const contract = createDefaultContract('permanent');
    contract.employer.companyName = '';
    const errors = validateLaborContract(contract);
    expect(errors).toContainEqual({
      field: 'employer.companyName',
      message: '사업체명은 필수입니다.'
    });
  });
});
```

### 통합 테스트
- 사용자 시나리오별 E2E 테스트
- PDF 생성 결과 검증
- 브라우저 호환성 테스트

## 배포 및 운영

### 빌드 최적화
- 정적 자산 압축
- 이미지 최적화
- CDN 활용

### 모니터링
- 오류 로깅 시스템
- 사용자 행동 분석
- 성능 메트릭 수집

이 시스템은 사용자 친화적인 인터페이스와 강력한 검증 시스템을 통해 정확하고 법적 기준에 맞는 근로계약서를 쉽게 작성할 수 있도록 설계되었습니다.
