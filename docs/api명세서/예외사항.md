# 스케줄 예외사항 관리 API 명세서

## 개요
HR 관리 시스템의 스케줄 예외사항 등록 및 관리를 위한 API 명세서입니다.  
5단계 위저드 방식으로 예외사항을 등록하며, 템플릿 기반 스케줄 시스템과 연동됩니다.

## 데이터베이스 스키마

### schedule_exceptions 테이블
```sql
CREATE TABLE schedule_exceptions (
  id SERIAL PRIMARY KEY,
  store_id INTEGER REFERENCES store_settings(id) ON DELETE CASCADE,
  employee_id INTEGER REFERENCES employees(id) ON DELETE CASCADE,
  template_id INTEGER REFERENCES weekly_schedule_templates(id) ON DELETE SET NULL,
  date DATE NOT NULL,
  start_time TIME,
  end_time TIME,
  exception_type VARCHAR(20) NOT NULL CHECK (exception_type IN ('CANCEL', 'OVERRIDE', 'ADDITIONAL')),
  notes TEXT,
  exception_data JSONB DEFAULT '{}',
  affected_slots JSONB DEFAULT '[]',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  CONSTRAINT unique_exception_per_template_date_employee 
    UNIQUE(template_id, employee_id, date, exception_type)
);
```

### 예외사항 유형 (exception_type)
- **CANCEL**: 해당 날짜 근무 취소 (휴무)
- **OVERRIDE**: 해당 날짜 근무시간 변경
- **ADDITIONAL**: 추가 근무

### JSONB 필드 구조

#### exception_data
```json
{
  "original_schedule": [
    {
      "day": "monday",
      "dayName": "월요일",
      "timeSlot": "09:00",
      "employees": [
        {
          "id": 1,
          "name": "김직원",
          "hourly_wage": 10030
        }
      ]
    }
  ],
  "selected_time_slots": ["09:00", "10:00"],
  "reason": "개인 사정으로 인한 휴무"
}
```

#### affected_slots
```json
[
  {
    "day": "monday",
    "time_slot": "09:00",
    "original_employees": [1, 2, 3],
    "exception_type": "CANCEL"
  }
]
```

## API 함수 목록

### 1. 기본 데이터 조회 API

#### getUserStores(userId: string)
**목적**: 사용자가 소유한 스토어 목록 조회  
**파라미터**: 
- `userId`: 사용자 UUID

**반환값**: `StoreData[]`
```typescript
interface StoreData {
  id: number
  owner_id: string
  store_name: string
  time_slot_minutes: number
  created_at?: string
  updated_at?: string
}
```

**Supabase 쿼리**:
```sql
SELECT * FROM store_settings 
WHERE owner_id = ? 
ORDER BY created_at DESC
```

#### getStoreTemplates(storeId: number)
**목적**: 특정 스토어의 스케줄 템플릿 목록 조회  
**파라미터**: 
- `storeId`: 스토어 ID

**반환값**: `TemplateData[]`
```typescript
interface TemplateData {
  id: number
  store_id: number
  template_name: string
  schedule_data: any
  is_active: boolean
  created_at: string
  updated_at: string
}
```

**Supabase 쿼리**:
```sql
SELECT * FROM weekly_schedule_templates 
WHERE store_id = ? 
ORDER BY created_at DESC
```

#### getStoreEmployees(storeId: number, ownerId: string)
**목적**: 특정 스토어의 활성 직원 목록 조회  
**파라미터**: 
- `storeId`: 스토어 ID
- `ownerId`: 소유자 UUID

**반환값**: `EmployeeData[]`
```typescript
interface EmployeeData {
  id: number
  store_id?: number
  owner_id: string
  name: string
  hourly_wage: number
  position?: string
  phone?: string
  is_active: boolean
  created_at: string
  updated_at: string
}
```

**Supabase 쿼리**:
```sql
SELECT * FROM employees 
WHERE store_id = ? AND owner_id = ? AND is_active = true 
ORDER BY created_at DESC
```

#### getStoreExceptions(storeId: number)
**목적**: 특정 스토어의 예외사항 목록 조회  
**파라미터**: 
- `storeId`: 스토어 ID

**반환값**: `ExceptionData[]`
```typescript
interface ExceptionData {
  id: number
  store_id?: number
  employee_id?: number
  template_id?: number
  date: string
  exception_type: 'CANCEL' | 'OVERRIDE' | 'ADDITIONAL'
  start_time?: string
  end_time?: string
  notes?: string
  exception_data?: any
  affected_slots?: any[]
  created_at: string
  updated_at: string
}
```

**Supabase 쿼리**:
```sql
SELECT * FROM schedule_exceptions 
WHERE store_id = ? 
ORDER BY date DESC
```

### 2. 예외사항 생성/삭제 API

#### createException(exceptionData)
**목적**: 새로운 예외사항 등록  
**파라미터**: 
- `exceptionData`: 예외사항 데이터 (id, created_at, updated_at 제외)

**반환값**: `ExceptionData`

**Supabase 쿼리**:
```sql
INSERT INTO schedule_exceptions (
  store_id, employee_id, template_id, date, 
  exception_type, start_time, end_time, 
  notes, exception_data, affected_slots
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
RETURNING *
```

**데이터 변환 과정**:
1. 위저드 데이터를 `buildExceptionDataFromWizard()` 함수로 변환
2. `exception_data`와 `affected_slots` JSONB 필드 생성
3. 데이터베이스에 삽입

#### deleteException(exceptionId: number)
**목적**: 예외사항 삭제  
**파라미터**: 
- `exceptionId`: 예외사항 ID

**반환값**: `boolean`

**Supabase 쿼리**:
```sql
DELETE FROM schedule_exceptions 
WHERE id = ?
```

### 3. 유틸리티 함수

#### getEmployeeWorkingSlots(template, employeeId, targetDate, employees)
**목적**: 특정 날짜에 직원이 근무하는 시간대 조회  
**파라미터**: 
- `template`: 템플릿 데이터
- `employeeId`: 직원 ID
- `targetDate`: 대상 날짜 (YYYY-MM-DD)
- `employees`: 직원 목록

**반환값**: `WorkingSlot[]`
```typescript
interface WorkingSlot {
  day: string        // 'monday', 'tuesday', ...
  dayName: string    // '월요일', '화요일', ...
  timeSlot: string   // '09:00', '10:00', ...
  employees: EmployeeData[]
}
```

**처리 로직**:
1. 날짜를 요일로 변환 (일요일=0 → 토요일=6)
2. 템플릿의 `schedule_data[요일].time_slots`에서 해당 직원이 포함된 시간대 추출
3. 시간순으로 정렬하여 반환

#### buildExceptionDataFromWizard(wizardData, storeId)
**목적**: 위저드 데이터를 DB 저장용 형태로 변환  
**파라미터**: 
- `wizardData`: 위저드에서 수집한 데이터
- `storeId`: 스토어 ID

**반환값**: DB 삽입용 예외사항 데이터

**변환 과정**:
```typescript
// exception_data 생성
const exceptionData = {
  original_schedule: wizardData.working_slots,
  selected_time_slots: wizardData.selected_slots,
  reason: wizardData.notes || null
}

// affected_slots 생성
const affectedSlots = wizardData.working_slots
  .filter(slot => wizardData.selected_slots.includes(slot.timeSlot))
  .map(slot => ({
    day: slot.day,
    time_slot: slot.timeSlot,
    original_employees: slot.employees.map(emp => emp.id),
    exception_type: wizardData.exception_type
  }))

// 최종 데이터 구성
return {
  store_id: storeId,
  employee_id: wizardData.employee_id,
  template_id: wizardData.template_id,
  date: wizardData.date,
  exception_type: wizardData.exception_type,
  start_time: wizardData.exception_type !== 'CANCEL' ? wizardData.start_time : null,
  end_time: wizardData.exception_type !== 'CANCEL' ? wizardData.end_time : null,
  notes: wizardData.notes || null,
  exception_data: exceptionData,
  affected_slots: affectedSlots
}
```

#### getThisWeekExceptions(exceptions)
**목적**: 이번 주 예외사항만 필터링  
**파라미터**: 
- `exceptions`: 전체 예외사항 목록

**반환값**: 이번 주 예외사항 목록

**필터링 로직**:
```typescript
const now = new Date()
const startOfWeek = new Date(now)
startOfWeek.setDate(now.getDate() - now.getDay())
startOfWeek.setHours(0, 0, 0, 0)

const endOfWeek = new Date(startOfWeek)
endOfWeek.setDate(startOfWeek.getDate() + 6)
endOfWeek.setHours(23, 59, 59, 999)

return exceptions.filter(exception => {
  const exceptionDate = new Date(exception.date)
  return exceptionDate >= startOfWeek && exceptionDate <= endOfWeek
})
```

## 5단계 위저드 프로세스

### 1단계: 스케줄 템플릿 선택
- 사용자가 소유한 스토어의 활성 템플릿 목록 표시
- 선택된 템플릿 ID를 `wizardData.template_id`에 저장

### 2단계: 직원 및 날짜 선택
- 해당 스토어의 활성 직원 목록 표시
- 예외사항 적용 날짜 선택
- 예외사항 유형 선택 (CANCEL/OVERRIDE/ADDITIONAL)

### 3단계: 근무 중인 시간대 확인
- `getEmployeeWorkingSlots()` 함수로 해당 날짜의 근무 시간대 조회
- 근무 예정이 없는 경우 안내 메시지 표시
- 근무 시간대와 함께 근무하는 동료 직원 정보 표시

### 4단계: 시간 선택
- **CANCEL 유형**: 취소할 시간대 체크박스로 선택
- **OVERRIDE/ADDITIONAL 유형**: 새로운 시작/종료 시간 입력

### 5단계: 메모 입력 및 등록
- 선택사항으로 메모 입력
- 입력된 모든 정보 요약 표시
- `handleCreateException()` 함수로 최종 등록

## 구체적인 데이터 저장 과정

### 실제 예제: 휴무(CANCEL) 예외사항 등록

#### 1단계: 위저드 데이터 수집
사용자가 5단계 위저드를 통해 입력한 데이터:
```typescript
const wizardData: ExceptionWizardData = {
  step: 5,
  template_id: 1,
  employee_id: 3,
  date: "2025-01-27",
  exception_type: "CANCEL",
  working_slots: [
    {
      day: "monday",
      dayName: "월요일", 
      timeSlot: "09:00",
      employees: [
        { id: 3, name: "김직원", hourly_wage: 12000, position: "매니저" },
        { id: 5, name: "이직원", hourly_wage: 10030, position: "알바" }
      ]
    },
    {
      day: "monday",
      dayName: "월요일",
      timeSlot: "10:00", 
      employees: [
        { id: 3, name: "김직원", hourly_wage: 12000, position: "매니저" }
      ]
    }
  ],
  selected_slots: ["09:00", "10:00"], // 취소할 시간대
  start_time: "09:00",
  end_time: "18:00", 
  notes: "개인 사정으로 인한 휴무",
  exception_data: {},
  affected_slots: []
}
```

#### 2단계: buildExceptionDataFromWizard() 함수 호출
**함수 위치**: `/lib/api/(page)/schedule/exceptions/exceptions-api.ts` (212-243줄)

```typescript
// 입력: wizardData, storeId = 1
const result = buildExceptionDataFromWizard(wizardData, 1)
```

**내부 처리 과정**:
```typescript
// exception_data 생성 (217-220줄)
const exceptionData = {
  original_schedule: wizardData.working_slots,
  selected_time_slots: wizardData.selected_slots, 
  reason: wizardData.notes || null
}

// affected_slots 생성 (222-229줄)
const affectedSlots = wizardData.working_slots
  .filter(slot => wizardData.selected_slots.includes(slot.timeSlot))
  .map(slot => ({
    day: slot.day,
    time_slot: slot.timeSlot,
    original_employees: slot.employees.map(emp => emp.id),
    exception_type: wizardData.exception_type
  }))
```

**변환된 최종 데이터**:
```typescript
{
  store_id: 1,
  employee_id: 3,
  template_id: 1,
  date: "2025-01-27",
  exception_type: "CANCEL",
  start_time: null, // CANCEL 유형이므로 null
  end_time: null,   // CANCEL 유형이므로 null
  notes: "개인 사정으로 인한 휴무",
  exception_data: {
    original_schedule: [
      {
        day: "monday",
        dayName: "월요일",
        timeSlot: "09:00", 
        employees: [
          { id: 3, name: "김직원", hourly_wage: 12000, position: "매니저" },
          { id: 5, name: "이직원", hourly_wage: 10030, position: "알바" }
        ]
      },
      {
        day: "monday", 
        dayName: "월요일",
        timeSlot: "10:00",
        employees: [
          { id: 3, name: "김직원", hourly_wage: 12000, position: "매니저" }
        ]
      }
    ],
    selected_time_slots: ["09:00", "10:00"],
    reason: "개인 사정으로 인한 휴무"
  },
  affected_slots: [
    {
      day: "monday",
      time_slot: "09:00",
      original_employees: [3, 5],
      exception_type: "CANCEL"
    },
    {
      day: "monday", 
      time_slot: "10:00",
      original_employees: [3],
      exception_type: "CANCEL"
    }
  ]
}
```

#### 3단계: createException() 함수로 DB 저장
**함수 위치**: `/lib/api/(page)/schedule/exceptions/exceptions-api.ts` (146-162줄)

```typescript
const savedData = await createException(result)
```

**실행되는 Supabase 쿼리**:
```sql
INSERT INTO schedule_exceptions (
  store_id, employee_id, template_id, date, exception_type,
  start_time, end_time, notes, exception_data, affected_slots
) VALUES (
  1, 3, 1, '2025-01-27', 'CANCEL',
  NULL, NULL, '개인 사정으로 인한 휴무',
  '{"original_schedule": [...], "selected_time_slots": ["09:00", "10:00"], "reason": "개인 사정으로 인한 휴무"}',
  '[{"day": "monday", "time_slot": "09:00", "original_employees": [3, 5], "exception_type": "CANCEL"}, {...}]'
) RETURNING *
```

#### 4단계: 최종 DB 저장 결과
```sql
-- schedule_exceptions 테이블에 저장된 레코드
id: 15
store_id: 1
employee_id: 3
template_id: 1
date: '2025-01-27'
exception_type: 'CANCEL'
start_time: NULL
end_time: NULL
notes: '개인 사정으로 인한 휴무'
exception_data: {
  "reason": "개인 사정으로 인한 휴무",
  "original_schedule": [
    {
      "day": "monday",
      "dayName": "월요일", 
      "timeSlot": "09:00",
      "employees": [
        {"id": 3, "name": "김직원", "hourly_wage": 12000, "position": "매니저"},
        {"id": 5, "name": "이직원", "hourly_wage": 10030, "position": "알바"}
      ]
    },
    {
      "day": "monday",
      "dayName": "월요일",
      "timeSlot": "10:00", 
      "employees": [
        {"id": 3, "name": "김직원", "hourly_wage": 12000, "position": "매니저"}
      ]
    }
  ],
  "selected_time_slots": ["09:00", "10:00"]
}
affected_slots: [
  {
    "day": "monday",
    "time_slot": "09:00", 
    "original_employees": [3, 5],
    "exception_type": "CANCEL"
  },
  {
    "day": "monday",
    "time_slot": "10:00",
    "original_employees": [3], 
    "exception_type": "CANCEL"
  }
]
created_at: '2025-01-24T15:30:00.000Z'
updated_at: '2025-01-24T15:30:00.000Z'
```

### 실제 예제: 시간변경(OVERRIDE) 예외사항 등록

#### 위저드 데이터
```typescript
const wizardData: ExceptionWizardData = {
  step: 5,
  template_id: 1,
  employee_id: 2,
  date: "2025-01-28",
  exception_type: "OVERRIDE",
  working_slots: [
    {
      day: "tuesday",
      dayName: "화요일",
      timeSlot: "14:00",
      employees: [
        { id: 2, name: "박직원", hourly_wage: 11000, position: "사원" }
      ]
    }
  ],
  selected_slots: ["14:00"],
  start_time: "16:00", // 변경된 시작 시간
  end_time: "20:00",   // 변경된 종료 시간
  notes: "병원 방문으로 인한 시간 변경",
  exception_data: {},
  affected_slots: []
}
```

#### 최종 DB 저장 결과
```sql
-- OVERRIDE 유형의 경우 start_time, end_time이 저장됨
id: 16
store_id: 1
employee_id: 2
template_id: 1
date: '2025-01-28'
exception_type: 'OVERRIDE'
start_time: '16:00:00'
end_time: '20:00:00'
notes: '병원 방문으로 인한 시간 변경'
exception_data: {
  "reason": "병원 방문으로 인한 시간 변경",
  "original_schedule": [...],
  "selected_time_slots": ["14:00"]
}
affected_slots: [
  {
    "day": "tuesday",
    "time_slot": "14:00",
    "original_employees": [2],
    "exception_type": "OVERRIDE"
  }
]
```

### 핵심 함수별 역할

#### buildExceptionDataFromWizard() 함수
- **위치**: `exceptions-api.ts` 212-243줄
- **역할**: 위저드 데이터를 DB 저장 형태로 변환
- **핵심 로직**:
  - `exception_data` JSONB: 원본 스케줄, 선택된 시간대, 사유 저장
  - `affected_slots` JSONB: 영향받는 시간대와 직원 ID 배열 저장
  - CANCEL 유형은 `start_time`, `end_time`을 null로 설정

#### createException() 함수  
- **위치**: `exceptions-api.ts` 146-162줄
- **역할**: 변환된 데이터를 Supabase에 INSERT
- **핵심 로직**:
  - `.insert([exceptionData])`: 단일 레코드 삽입
  - `.select().single()`: 삽입된 레코드 반환
  - JSONB 필드는 자동으로 JSON 문자열로 변환되어 저장

## 데이터 흐름

### 예외사항 등록 흐름
```
1. 사용자 입력 (5단계 위저드)
   ↓
2. buildExceptionDataFromWizard() - 데이터 변환
   ↓  
3. createException() - Supabase INSERT
   ↓
4. loadExceptions() - 목록 새로고침
```

### 데이터 조회 흐름
```
1. 페이지 로드
   ↓
2. getUserStores() - 스토어 목록
   ↓
3. 스토어 선택 시:
   - getStoreTemplates() - 템플릿 목록
   - getStoreEmployees() - 직원 목록  
   - getStoreExceptions() - 예외사항 목록
```

## 에러 처리

### 공통 에러 처리
- 모든 API 함수는 try-catch로 에러 처리
- 콘솔 로그와 사용자 토스트 메시지 표시
- Supabase 에러는 그대로 throw하여 상위에서 처리

### 유효성 검증
- 필수 필드 누락 시 에러 메시지
- 시간 유효성 검증 (종료 시간 > 시작 시간)
- 중복 예외사항 방지 (DB constraint)

## 보안 및 권한

### Row Level Security (RLS)
- 모든 테이블에 RLS 정책 적용
- 스토어 소유자만 해당 스토어 데이터 접근 가능
- `auth.uid()`를 통한 사용자 인증 확인

### 권한 검증
```sql
-- 예외사항 접근 권한 확인
CREATE POLICY "Users can access exceptions of their stores" 
ON schedule_exceptions FOR ALL USING (
  EXISTS (
    SELECT 1 FROM store_settings 
    WHERE store_settings.id = schedule_exceptions.store_id 
    AND store_settings.owner_id = auth.uid()
  )
);
```

## 성능 최적화

### 인덱스
```sql
-- 주요 조회 패턴에 대한 인덱스
CREATE INDEX idx_schedule_exceptions_store_id ON schedule_exceptions(store_id);
CREATE INDEX idx_schedule_exceptions_template_id ON schedule_exceptions(template_id);
CREATE INDEX idx_schedule_exceptions_date_range ON schedule_exceptions(date);
CREATE INDEX idx_schedule_exceptions_exception_data ON schedule_exceptions USING GIN(exception_data);
CREATE INDEX idx_schedule_exceptions_affected_slots ON schedule_exceptions USING GIN(affected_slots);
```

### 쿼리 최적화
- 날짜 범위 조회 시 인덱스 활용
- JSONB 필드 조회 시 GIN 인덱스 활용
- 필요한 컬럼만 SELECT하여 데이터 전송량 최소화

## 실제 데이터 저장 구조 및 함수 호출 예제

### 데이터베이스 스키마
```sql
CREATE TABLE schedule_exceptions (
  id SERIAL PRIMARY KEY,
  store_id INTEGER REFERENCES public.store_settings(id) ON DELETE CASCADE,
  employee_id INTEGER REFERENCES employees(id) ON DELETE CASCADE,
  template_id INTEGER REFERENCES weekly_schedule_templates(id) ON DELETE SET NULL,
  date DATE NOT NULL,
  start_time TIME,
  end_time TIME,
  exception_type VARCHAR(20) NOT NULL CHECK (exception_type IN ('CANCEL', 'OVERRIDE', 'ADDITIONAL')),
  notes TEXT,
  exception_data JSONB DEFAULT '{}', -- 예외사항 상세 정보
  affected_slots JSONB DEFAULT '[]', -- 영향받는 시간대 정보
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  CONSTRAINT unique_exception_per_template_date_employee 
    UNIQUE(template_id, employee_id, date, exception_type)
);
```

### 핵심 함수: `createException`
**위치**: `/lib/api/(page)/schedule/exceptions/exceptions-api.ts`

```typescript
export async function createException(
  exceptionData: Omit<ExceptionData, 'id' | 'created_at' | 'updated_at'>
): Promise<ExceptionData> {
  try {
    const { data, error } = await supabase
      .from('schedule_exceptions')
      .insert([exceptionData])
      .select()
      .single()

    if (error) throw error
    return data
  } catch (error) {
    console.error('예외사항 생성 오류:', error)
    throw error
  }
}
```

### 핵심 함수: `buildExceptionDataFromWizard`
**위치**: `/lib/api/(page)/schedule/exceptions/exceptions-api.ts`

```typescript
export function buildExceptionDataFromWizard(
  wizardData: ExceptionWizardData,
  storeId: number
): Omit<ExceptionData, 'id' | 'created_at' | 'updated_at'> {
  const exceptionData = {
    original_schedule: wizardData.working_slots,
    selected_time_slots: wizardData.selected_slots,
    reason: wizardData.notes || null
  }
  
  const affectedSlots = wizardData.working_slots
    .filter(slot => wizardData.selected_slots.includes(slot.timeSlot))
    .map(slot => ({
      day: slot.day,
      time_slot: slot.timeSlot,
      original_employees: slot.employees.map(emp => emp.id),
      exception_type: wizardData.exception_type
    }))

  return {
    store_id: storeId,
    employee_id: wizardData.employee_id!,
    template_id: wizardData.template_id!,
    date: wizardData.date,
    exception_type: wizardData.exception_type!,
    start_time: wizardData.exception_type !== 'CANCEL' ? wizardData.start_time : null,
    end_time: wizardData.exception_type !== 'CANCEL' ? wizardData.end_time : null,
    notes: wizardData.notes || null,
    exception_data: exceptionData,
    affected_slots: affectedSlots
  }
}
```

### 실제 저장 예제

#### 1. 휴무(CANCEL) 예외사항
**함수 호출**:
```typescript
const wizardData = {
  step: 4,
  template_id: 1,
  employee_id: 5,
  date: '2025-01-25',
  exception_type: 'CANCEL',
  working_slots: [
    {
      day: 'saturday',
      dayName: '토요일',
      timeSlot: '09:00-13:00',
      employees: [{ id: 5, name: '김직원', hourly_wage: 12000 }]
    }
  ],
  selected_slots: ['09:00-13:00'],
  start_time: '',
  end_time: '',
  notes: '개인사정으로 인한 휴무',
  exception_data: {},
  affected_slots: []
}

const exceptionData = buildExceptionDataFromWizard(wizardData, 1)
const result = await createException(exceptionData)
```

**실제 저장되는 데이터**:
```json
{
  "id": 1,
  "store_id": 1,
  "employee_id": 5,
  "template_id": 1,
  "date": "2025-01-25",
  "start_time": null,
  "end_time": null,
  "exception_type": "CANCEL",
  "notes": "개인사정으로 인한 휴무",
  "exception_data": {
    "original_schedule": [
      {
        "day": "saturday",
        "dayName": "토요일", 
        "timeSlot": "09:00-13:00",
        "employees": [
          {
            "id": 5,
            "name": "김직원",
            "hourly_wage": 12000
          }
        ]
      }
    ],
    "selected_time_slots": ["09:00-13:00"],
    "reason": "개인사정으로 인한 휴무"
  },
  "affected_slots": [
    {
      "day": "saturday",
      "time_slot": "09:00-13:00", 
      "original_employees": [5],
      "exception_type": "CANCEL"
    }
  ],
  "created_at": "2025-01-24T15:30:00.000Z",
  "updated_at": "2025-01-24T15:30:00.000Z"
}
```

#### 2. 근무시간 변경(OVERRIDE) 예외사항
**함수 호출**:
```typescript
const wizardData = {
  step: 4,
  template_id: 1,
  employee_id: 3,
  date: '2025-01-26',
  exception_type: 'OVERRIDE',
  working_slots: [
    {
      day: 'sunday',
      dayName: '일요일',
      timeSlot: '10:00-18:00',
      employees: [{ id: 3, name: '박직원', hourly_wage: 11000 }]
    }
  ],
  selected_slots: ['10:00-18:00'],
  start_time: '12:00',
  end_time: '20:00',
  notes: '매장 행사로 인한 근무시간 연장',
  exception_data: {},
  affected_slots: []
}

const exceptionData = buildExceptionDataFromWizard(wizardData, 1)
const result = await createException(exceptionData)
```

**실제 저장되는 데이터**:
```json
{
  "id": 2,
  "store_id": 1,
  "employee_id": 3,
  "template_id": 1,
  "date": "2025-01-26",
  "start_time": "12:00:00",
  "end_time": "20:00:00",
  "exception_type": "OVERRIDE",
  "notes": "매장 행사로 인한 근무시간 연장",
  "exception_data": {
    "original_schedule": [
      {
        "day": "sunday",
        "dayName": "일요일",
        "timeSlot": "10:00-18:00",
        "employees": [
          {
            "id": 3,
            "name": "박직원",
            "hourly_wage": 11000
          }
        ]
      }
    ],
    "selected_time_slots": ["10:00-18:00"],
    "reason": "매장 행사로 인한 근무시간 연장"
  },
  "affected_slots": [
    {
      "day": "sunday",
      "time_slot": "10:00-18:00",
      "original_employees": [3],
      "exception_type": "OVERRIDE"
    }
  ],
  "created_at": "2025-01-24T15:35:00.000Z",
  "updated_at": "2025-01-24T15:35:00.000Z"
}
```

#### 3. 추가 근무(ADDITIONAL) 예외사항
**함수 호출**:
```typescript
const wizardData = {
  step: 4,
  template_id: 2,
  employee_id: 7,
  date: '2025-01-27',
  exception_type: 'ADDITIONAL',
  working_slots: [], // 기존 스케줄 없음
  selected_slots: [],
  start_time: '19:00',
  end_time: '23:00',
  notes: '재고정리 추가 근무',
  exception_data: {},
  affected_slots: []
}

const exceptionData = buildExceptionDataFromWizard(wizardData, 1)
const result = await createException(exceptionData)
```

**실제 저장되는 데이터**:
```json
{
  "id": 3,
  "store_id": 1,
  "employee_id": 7,
  "template_id": 2,
  "date": "2025-01-27",
  "start_time": "19:00:00",
  "end_time": "23:00:00",
  "exception_type": "ADDITIONAL",
  "notes": "재고정리 추가 근무",
  "exception_data": {
    "original_schedule": [],
    "selected_time_slots": [],
    "reason": "재고정리 추가 근무"
  },
  "affected_slots": [],
  "created_at": "2025-01-24T15:40:00.000Z",
  "updated_at": "2025-01-24T15:40:00.000Z"
}
```

### JSONB 필드 상세 구조

#### `exception_data` JSONB 필드
```typescript
interface ExceptionDataJsonb {
  original_schedule: WorkingSlot[]; // 원본 스케줄 정보
  selected_time_slots: string[];    // 선택된 시간대 목록
  reason: string | null;            // 예외사항 사유
}
```

#### `affected_slots` JSONB 필드
```typescript
interface AffectedSlot {
  day: string;                      // 요일 (monday, tuesday, ...)
  time_slot: string;                // 시간대 (예: "09:00-13:00")
  original_employees: number[];     // 원래 배정된 직원 ID 목록
  exception_type: string;           // 예외사항 타입
}
```

### 데이터 조회 예제

#### 이번 주 예외사항 조회
```typescript
// 함수 호출
const exceptions = await getStoreExceptions(1);
const thisWeekExceptions = getThisWeekExceptions(exceptions);

// 결과 예시
[
  {
    "id": 1,
    "store_id": 1,
    "employee_id": 5,
    "date": "2025-01-25",
    "exception_type": "CANCEL",
    "notes": "개인사정으로 인한 휴무",
    // ... 위에서 본 전체 데이터
  }
]
```

## 향후 개선 사항

### 기능 확장
- 반복 예외사항 등록 (매주, 매월)
- 예외사항 승인 워크플로우
- 예외사항 통계 및 리포트

### 성능 개선
- 캐싱 전략 도입
- 페이지네이션 구현
- 실시간 업데이트 (WebSocket)

---

**작성일**: 2025-01-24  
**버전**: 1.1  
**작성자**: HR 관리 시스템 개발팀
