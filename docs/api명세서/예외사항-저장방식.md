# 예외사항 저장 방식 API 명세서

## 📋 개요
HR 관리 시스템의 예외사항 저장 프로세스와 데이터 구조를 설명합니다.

## 🔧 핵심 함수

### `buildExceptionDataFromWizard()`
위저드 데이터를 DB 저장용 형태로 변환합니다.

```typescript
function buildExceptionDataFromWizard(
  wizardData: ExceptionWizardData,
  storeId: number
): ExceptionData
```

## 📊 저장 데이터 구조

### 공통 필드
```typescript
{
  store_id: number,           // 스토어 ID
  employee_id: number,        // 직원 ID  
  template_id: number,        // 템플릿 ID
  date: string,              // 날짜 (YYYY-MM-DD)
  exception_type: string,    // 예외사항 유형
  notes?: string,            // 메모 (선택사항)
  exception_data: {},        // 빈 객체 (호환성)
  affected_slots: []         // 빈 배열 (호환성)
}
```

## 🎯 예외사항 유형별 저장

### 1. 휴무 (CANCEL)
```json
{
  "store_id": 5,
  "employee_id": 12,
  "template_id": 11,
  "date": "2025-08-29",
  "exception_type": "CANCEL",
  "start_time": undefined,
  "end_time": undefined,
  "notes": "개인사정으로 인한 휴무"
}
```

### 2. 시간변경 (OVERRIDE)
```json
{
  "store_id": 5,
  "employee_id": 12,
  "template_id": 11,
  "date": "2025-08-29",
  "exception_type": "OVERRIDE",
  "start_time": "10:00",
  "end_time": "18:00",
  "notes": "개인사정으로 시간 변경"
}
```

### 3. 추가근무 (EXTRA)
```json
{
  "store_id": 5,
  "employee_id": 12,
  "template_id": 11,
  "date": "2025-08-29",
  "exception_type": "EXTRA",
  "start_time": "21:00",
  "end_time": "23:00",
  "notes": "야간 추가 근무"
}
```

## 🔍 DB 제약조건

### exception_type 허용 값
- `'CANCEL'` - 휴무
- `'OVERRIDE'` - 시간변경  
- `'EXTRA'` - 추가근무

### 유니크 제약조건
```sql
UNIQUE(template_id, employee_id, date, exception_type)
```

## ⚡ 저장 프로세스

1. **위저드 데이터 수집** → ExceptionWizardData
2. **데이터 변환** → buildExceptionDataFromWizard()
3. **DB 저장** → createException()
4. **성공 처리** → 목록 새로고침

## 🚨 주요 변경사항

- **JSONB 필드 최적화**: `exception_data`, `affected_slots`를 빈 객체/배열로 저장
- **타입 통일**: `ADDITIONAL` → `EXTRA`로 변경하여 DB 제약조건과 일치
- **단순화**: 모든 예외사항 유형이 동일한 저장 로직 사용
